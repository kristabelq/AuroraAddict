generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                String    @id @default(cuid())
  name              String?
  username          String?   @unique // Unique handle like @kristabelq
  email             String?   @unique
  password          String?   // Hashed password for email/password authentication
  emailVerified     DateTime?
  image             String?
  bio               String?
  onboardingComplete Boolean  @default(false)

  // Social/Contact fields
  instagram         String?   // Instagram handle (without @)
  whatsappNumber    String?   // WhatsApp number with country code (no spaces, dashes, or plus signs)
  publicEmail       String?   // Public email for contact

  // Stripe Connect fields for receiving payments
  stripeAccountId   String?   @unique // Stripe Connect account ID
  stripeOnboarded   Boolean   @default(false) // Whether Stripe onboarding is complete
  stripeOnboardedAt DateTime? // When Stripe onboarding was completed

  // User Type System (for chat)
  userType          String    @default("personal") // 'personal' | 'business'

  // Business Verification
  businessName            String?
  businessCategory        String?   // LEGACY: 'accommodation' | 'tour_operator' | 'photography' | 'restaurant' | 'shop' | 'other'
  businessServices        String[]  @default([]) // NEW: ['accommodation', 'restaurant', 'shop', 'tours', 'photography']
  businessDescription     String?   @db.Text // Business description
  businessWebsite         String?
  businessPhone           String?
  businessEmail           String?   // Business contact email
  businessAddress         String?
  businessCity            String?
  businessCountry         String?   @default("Finland")
  latitude                Float?    // Business location latitude
  longitude               Float?    // Business location longitude
  businessLicenseUrl      String?   // Business license document URL
  idDocumentUrl           String?   // ID document URL
  businessDocuments       String[]  // Legacy field - URLs to uploaded verification docs

  verificationStatus      String    @default("unverified") // 'unverified' | 'pending' | 'verified' | 'rejected'
  verificationSubmittedAt DateTime? // When verification was submitted
  verifiedAt              DateTime?
  verifiedBy              String?   // Admin user ID who verified
  rejectionReason         String?

  // Cached counters for performance (updated on create/join actions)
  cachedSightingsCount      Int @default(0) // Total sightings posted
  cachedHuntsCreatedCount   Int @default(0) // Total hunts created
  cachedHuntsJoinedCount    Int @default(0) // Total hunts joined/participated
  cachedCompletedHuntsCount Int @default(0) // Total COMPLETED hunts (created or joined)
  cachedSuccessRate         Float @default(0) // Average success rate from COMPLETED hunts only
  cachedLastUpdated         DateTime @default(now()) // When cached stats were last updated

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  accounts          Account[]
  sessions          Session[]
  sightings         Sighting[]
  hunts             Hunt[]
  huntParticipants  HuntParticipant[]
  comments          Comment[]
  likes             Like[]
  following         Follow[]  @relation("UserFollowing")
  followers         Follow[]  @relation("UserFollowers")
  cityBadges        CityBadge[]

  // Chat relations
  ownedChatGroups   ChatGroup[] @relation("ChatGroupOwner")
  chatMemberships   ChatMembership[]
  chatMessages      ChatMessage[]
  chatJoinRequests  ChatJoinRequest[]
  businessSubscriptions BusinessChatSubscription[]
  messageReactions  MessageReaction[]

  // Business service relations
  roomTypes         RoomType[]
  tourExperiences   TourExperience[] @relation("TourExperiences")

  // Review relations
  reviewsReceived   Review[] @relation("BusinessReviews") // Reviews of this business
  reviewsWritten    Review[] @relation("UserReviews")     // Reviews written by this user
  reviewResponses   ReviewResponse[] @relation("ReviewResponses") // Responses to reviews
  reviewHelpfulVotes ReviewHelpful[] @relation("ReviewHelpfulVotes") // Helpful votes cast

  // Advanced Aurora Forecasting relations
  locationPreference UserLocationPreference?
  quickSightings    QuickSighting[]

  // Affiliate Performance (for business accounts)
  totalAffiliateClicks       Int      @default(0)
  totalConversions           Int      @default(0)
  conversionRate             Float    @default(0) // Percentage
  totalCommissionEarned      Float    @default(0) // In EUR
  estimatedMonthlyCommission Float    @default(0)
  performanceLastUpdated     DateTime @default(now())

  @@index([userType])
  @@index([verificationStatus])
  @@index([latitude, longitude])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Sighting {
  id            String    @id @default(cuid())
  userId        String
  huntId        String?   // Optional - links sighting to a hunt's shared album
  caption       String?
  latitude      Float
  longitude     Float
  location      String

  // Image optimization: thumbnails for grids, full resolution for feeds
  images        String[]  // Full resolution image URLs (used in feed views)
  thumbnails    String[]  // Thumbnail URLs (400x400, used in profile/album grids)

  videos        String[]  // Array of video URLs
  sightingType  String    @default("realtime") // "realtime" or "past"
  sightingDate  DateTime? // Optional - actual date/time when the aurora was seen
  sightingTime  String?   // Optional - time component if needed separately
  timezone      String?   // Optional - timezone of the sighting
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  hunt        Hunt?    @relation(fields: [huntId], references: [id], onDelete: Cascade)
  comments    Comment[]
  likes       Like[]
  sharedInMessages ChatMessage[] // Messages that share this sighting

  // Performance indexes
  @@index([createdAt])
  @@index([userId])
  @@index([huntId])
  @@index([sightingDate])
  @@index([latitude, longitude])
  @@index([userId, createdAt]) // Composite for user's sightings timeline
}

model Hunt {
  id          String   @id @default(cuid())
  name        String
  description String?
  userId      String   // Creator
  coverImage  String?  // 16:9 landscape cover image URL (1600x900)
  additionalInfoUrl String? // URL for additional information
  whatsappNumber String? // WhatsApp number with country code (no spaces, dashes, or plus signs)
  startDate   DateTime
  endDate     DateTime
  timezone    String?  @default("UTC") // Timezone of the meeting point (e.g., "America/New_York", "UTC", "GMT+8")
  latitude    Float?
  longitude   Float?
  location    String?
  hideLocation Boolean @default(false)
  isPublic    Boolean  @default(true)
  hideFromPublic Boolean @default(false) // Hide from public hunt listings (only accessible via link)
  isPaid      Boolean  @default(false)
  price       Float?
  capacity    Int?
  allowWaitlist Boolean @default(false) // Allow waitlist when hunt is at full capacity
  cancellationPolicy String? // Cancellation policy for paid hunts
  hasParticipantsInTransition Boolean @default(false) // Prevents settings changes when users are in transition states

  // Cached statistics for performance (updated when sightings posted or hunt completes)
  cachedSuccessRate         Float?    @default(0) // Success rate: (nights with sightings / total nights) √ó 100
  cachedSightingsCount      Int?      @default(0) // Count of unique nights with sightings
  cachedUniqueParticipants  Int?      @default(0) // Count of unique users who posted sightings
  cachedStatsLastUpdated    DateTime? // When cached stats were last recalculated

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  participants HuntParticipant[]
  sightings   Sighting[]
  sharedInMessages ChatMessage[] // Messages that share this hunt
  chatGroup   ChatGroup? // Optional hunt group chat
  reviews     Review[] // Reviews mentioning this hunt

  @@index([startDate])
  @@index([latitude, longitude])
}

model HuntParticipant {
  id        String   @id @default(cuid())
  huntId    String
  userId    String
  status    String   @default("pending") // pending, confirmed, cancelled, waitlisted
  paymentStatus String? @default("pending") // pending, confirmed, cancelled - for manual payment tracking
  paidAt    DateTime?
  joinedAt  DateTime @default(now())

  // Edge case tracking fields
  requestExpiresAt DateTime? // When pending request/payment expires (7 days)
  rejectionCount   Int       @default(0) // Number of times rejected by owner
  isPaymentProcessing Boolean @default(false) // Prevent double payment attempts
  lastRejectedAt   DateTime? // When last rejection occurred
  waitlistPosition Int?      // Position in waitlist (for FIFO ordering)

  // Payment tracking
  stripePaymentIntentId String? @unique // Stripe PaymentIntent ID
  stripeCheckoutSessionId String? @unique // Stripe Checkout Session ID
  paymentAmount Float? // Amount paid in the currency
  paymentCurrency String? @default("usd") // Currency code (usd, eur, etc.)

  hunt      Hunt     @relation(fields: [huntId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([huntId, userId])
  @@index([requestExpiresAt]) // For cleanup job queries
  @@index([waitlistPosition]) // For efficient waitlist ordering
}

model Comment {
  id         String   @id @default(cuid())
  content    String
  userId     String
  sightingId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sighting   Sighting @relation(fields: [sightingId], references: [id], onDelete: Cascade)

  @@index([sightingId])
}

model Like {
  id         String   @id @default(cuid())
  userId     String
  sightingId String
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sighting   Sighting @relation(fields: [sightingId], references: [id], onDelete: Cascade)

  @@unique([userId, sightingId])
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String   // User who is following
  followingId String   // User being followed
  createdAt   DateTime @default(now())

  follower    User     @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model CityBadge {
  id          String   @id @default(cuid())
  userId      String
  city        String   // City name
  country     String   // Country name
  countryCode String   // For flag emoji (e.g., "FI", "SE", "NO")
  latitude    Float
  longitude   Float
  earnedAt    DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, city, country])
  @@index([userId])
}

// ============================================
// CHAT SYSTEM MODELS
// ============================================

model ChatGroup {
  id              String   @id @default(cuid())
  name            String
  description     String?

  // Type & Ownership
  groupType       String   // 'area' | 'business_public' | 'business_private' | 'hunt' | 'direct_message'
  visibility      String   // 'public' | 'private'

  // Location (optional for hunt/DM chats)
  countryCode     String?  @default("FI")
  countryName     String?  @default("Finland")
  areaName        String?   // 'Levi', 'Muonio', 'Rovaniemi', 'Inari', 'Saariselk√§' (null for hunt/DM)
  latitude        Float?
  longitude       Float?

  // Business Ownership (null for area chats)
  ownerId         String?
  owner           User?    @relation("ChatGroupOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  businessCategory String? // Mirrors owner's category

  // Hunt Chat (null for non-hunt chats)
  huntId          String?  @unique
  hunt            Hunt?    @relation(fields: [huntId], references: [id], onDelete: Cascade)

  // Linked Chats (pair public + private)
  linkedChatId    String?  @unique
  linkedChat      ChatGroup? @relation("LinkedChats", fields: [linkedChatId], references: [id], onDelete: SetNull)
  pairedChat      ChatGroup? @relation("LinkedChats")

  // Settings
  isActive        Boolean  @default(true)
  memberLimit     Int?     // For private chats (e.g., 50 max)
  requireApproval Boolean  @default(false) // True for private business chats

  // Moderation Settings
  slowModeSeconds Int?     // Null = off, 30 = 30 seconds between messages

  // Metadata
  avatarUrl       String?
  memberCount     Int      @default(0)
  messageCount    Int      @default(0)

  // Verification Badge
  isVerified      Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  members         ChatMembership[]
  messages        ChatMessage[]
  joinRequests    ChatJoinRequest[]

  @@index([countryCode, areaName])
  @@index([groupType, visibility])
  @@index([isActive])
  @@index([ownerId])
  @@index([huntId])
}

model ChatMembership {
  id            String   @id @default(cuid())
  chatGroupId   String
  userId        String

  role          String   @default("member") // 'owner' | 'moderator' | 'member'
  status        String   @default("active") // 'active' | 'muted' | 'banned'

  // Activity Tracking
  lastReadAt    DateTime?
  unreadCount   Int      @default(0)

  // Moderation
  mutedUntil    DateTime?
  mutedReason   String?
  bannedAt      DateTime?
  bannedBy      String?   // userId
  banReason     String?

  joinedAt      DateTime @default(now())

  chatGroup     ChatGroup @relation(fields: [chatGroupId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chatGroupId, userId])
  @@index([userId])
}

model ChatMessage {
  id            String   @id @default(cuid())
  chatGroupId   String
  userId        String

  content       String   @db.Text
  contentFiltered String? @db.Text // Auto-filtered version
  messageType   String   @default("text") // 'text' | 'image' | 'system' | 'sighting_share' | 'hunt_share'

  // Attachments (max 3 images)
  images        String[]

  // Shared Content
  sharedSightingId String?
  sharedHuntId     String?
  sharedSighting   Sighting? @relation(fields: [sharedSightingId], references: [id], onDelete: SetNull)
  sharedHunt       Hunt?     @relation(fields: [sharedHuntId], references: [id], onDelete: SetNull)

  // Moderation
  isPinned      Boolean  @default(false)
  pinnedBy      String?
  pinnedAt      DateTime?
  isEdited      Boolean  @default(false)
  isDeleted     Boolean  @default(false)
  deletedBy     String?
  deletedReason String?

  // Auto-moderation Flags
  hasProfanity  Boolean  @default(false)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  chatGroup     ChatGroup @relation(fields: [chatGroupId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  reactions     MessageReaction[]

  @@index([chatGroupId, createdAt])
  @@index([userId])
  @@index([sharedSightingId])
  @@index([sharedHuntId])
}

model ChatJoinRequest {
  id              String   @id @default(cuid())
  chatGroupId     String
  userId          String

  status          String   @default("pending") // 'pending' | 'approved' | 'rejected'
  message         String?  // Optional message from user

  // Review
  reviewedBy      String?
  reviewedAt      DateTime?
  responseMessage String?  // Optional message from business

  createdAt       DateTime @default(now())

  chatGroup       ChatGroup @relation(fields: [chatGroupId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chatGroupId, userId])
  @@index([status])
  @@index([userId])
}

model ModerationLog {
  id              String   @id @default(cuid())
  chatGroupId     String
  moderatorId     String
  targetUserId    String?  // User who was moderated
  targetMessageId String?  // Message that was moderated

  action          String   // 'delete_message' | 'mute_user' | 'ban_user' | 'pin_message' | 'slow_mode_enabled' | 'slow_mode_disabled'
  reason          String?
  duration        Int?     // For mutes/slow mode (seconds)

  createdAt       DateTime @default(now())

  @@index([chatGroupId, createdAt])
  @@index([moderatorId])
}

model BusinessChatSubscription {
  id                    String   @id @default(cuid())
  businessUserId        String

  // Area & Category
  areaName              String   // 'Levi', 'Muonio', etc.
  businessCategory      String   // For pricing calculation

  // Two chat groups
  publicChatId          String   @unique
  privateChatId         String   @unique

  // Stripe Integration
  stripeCustomerId      String?
  stripeSubscriptionId  String?  @unique
  stripePriceId         String?

  // Status
  status                String   // 'trialing' | 'active' | 'paused' | 'past_due' | 'cancelled' | 'expired'

  // Pricing
  monthlyPrice          Float    // ‚Ç¨59-79 depending on category
  currency              String   @default("EUR")
  billingPeriod         String   // 'monthly' | 'annual'

  // Dates
  trialStartDate        DateTime
  trialEndDate          DateTime
  startDate             DateTime
  currentPeriodEnd      DateTime

  // Pause Feature (max 3 months/year)
  pausedAt              DateTime?
  pauseMonthsUsed       Int      @default(0)

  // Cancellation
  cancelAt              DateTime?
  cancelledAt           DateTime?
  cancellationReason    String?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  businessUser          User     @relation(fields: [businessUserId], references: [id], onDelete: Cascade)

  @@unique([businessUserId, areaName]) // One subscription per business per area
  @@index([businessUserId])
  @@index([status])
  @@index([areaName])
}

model MessageReaction {
  id            String   @id @default(cuid())
  messageId     String
  userId        String
  emoji         String   // '‚ù§Ô∏è' | 'üëç' | 'üî•' | 'üëÄ' | 'üôè'

  createdAt     DateTime @default(now())

  message       ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
}

// ============================================
// BUSINESS SERVICE MODELS
// ============================================

model RoomType {
  id                String   @id @default(cuid())
  businessId        String
  business          User     @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Business-editable fields
  name              String
  description       String?  @db.Text
  capacity          Int      // Number of guests
  priceFrom         Float?   // Starting price per night
  currency          String   @default("EUR")

  // Images (array of URLs)
  images            String[] // URLs to room photos (max 10)
  coverImage        String?  // Primary image URL

  // Amenities
  amenities         String[] // ["Private Sauna", "Heated Glass Roof", "WiFi"]

  // Booking URLs (business provides, we inject affiliate params)
  bookingComUrl     String?  // Original URL from business
  agodaUrl          String?  // Original URL from business
  directBookingUrl  String?  // Business's own booking system

  // Platform-controlled (businesses CANNOT edit directly)
  // affiliateLinks JSON structure: { "booking": "...", "agoda": "...", "direct": "..." }
  affiliateLinks    Json?

  // Status
  isActive          Boolean  @default(true)
  displayOrder      Int      @default(0) // For sorting rooms

  // Analytics
  viewCount         Int      @default(0)
  clickCount        Int      @default(0)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([businessId, isActive])
}

model TourExperience {
  id                String   @id @default(cuid())
  businessId        String
  business          User     @relation("TourExperiences", fields: [businessId], references: [id], onDelete: Cascade)

  // Business-editable fields
  name              String
  description       String?  @db.Text
  duration          String   // "3 hours", "Full day", "2-3 hours"
  groupSizeMin      Int?     // Minimum group size
  groupSizeMax      Int?     // Maximum group size
  difficulty        String?  // "Easy", "Moderate", "Challenging"
  season            String?  // "Winter only", "Year-round", "Sept-March"

  // Pricing
  priceFrom         Float?   // Starting price per person
  currency          String   @default("EUR")

  // Media
  images            String[] // URLs to tour photos (max 10)
  coverImage        String?  // Primary image URL

  // Details
  highlights        String[] // ["Professional guide", "Photos included", "Warm clothing provided"]
  included          String[] // ["Hotel pickup", "Equipment", "Hot drinks"]

  // Booking URLs
  directBookingUrl  String?  // Business's own booking system
  getYourGuideUrl   String?
  viatorUrl         String?
  tripAdvisorUrl    String?

  // Platform-controlled affiliate links
  // affiliateLinks JSON structure: { "direct": "...", "getYourGuide": "...", "viator": "..." }
  affiliateLinks    Json?

  // Status
  isActive          Boolean  @default(true)
  displayOrder      Int      @default(0)

  // Analytics
  viewCount         Int      @default(0)
  clickCount        Int      @default(0)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([businessId, isActive])
}

model AffiliateClick {
  id                String   @id @default(cuid())

  // What was clicked
  businessId        String
  roomTypeId        String?  // Optional: specific room
  tourExperienceId  String?  // Optional: specific tour
  platform          String   // 'booking' | 'agoda' | 'direct' | 'getyourguide' | 'viator' | 'tripadvisor'
  destinationUrl    String   // The affiliate URL

  // Who clicked
  userId            String?  // If logged in
  sessionId         String?  // Anonymous tracking

  // Context
  sourceUrl         String?  // Where they came from
  deviceType        String?  // 'mobile' | 'desktop'
  userAgent         String?  // Browser/device info
  referrer          String?  // HTTP referrer
  utmSource         String?  // UTM tracking params
  utmMedium         String?
  utmCampaign       String?

  // A/B Testing
  ctaVariantId      String?  // Which CTA button variant was clicked

  // Conversion tracking (can be updated via webhook if available)
  converted         Boolean  @default(false)
  conversionValue   Float?   // Booking total
  conversionCurrency String? @default("EUR")
  conversionDate    DateTime?
  conversionSource  String?  // 'webhook' | 'manual' | 'estimated'

  // Commission calculation
  commissionRate    Float?   // Platform commission rate (%)
  estimatedCommission Float? // Calculated commission in EUR

  // Booking reference
  bookingReference  String?  // Platform's booking ID
  checkInDate       DateTime? // For accommodation bookings
  checkOutDate      DateTime? // For accommodation bookings
  guests            Int?     // Number of guests
  nights            Int?     // Number of nights (accommodation)

  clickedAt         DateTime @default(now())

  ctaVariant        CTAVariant? @relation(fields: [ctaVariantId], references: [id], onDelete: SetNull)

  @@index([businessId, clickedAt])
  @@index([platform])
  @@index([roomTypeId])
  @@index([tourExperienceId])
  @@index([converted])
  @@index([ctaVariantId])
  @@index([conversionDate])
}

// ============================================
// REVIEW & RATING SYSTEM
// ============================================

model Review {
  id                String   @id @default(cuid())

  // Who & Where
  businessId        String   // Business being reviewed
  userId            String   // Reviewer
  huntId            String?  // Optional: linked to a specific hunt they attended

  // Review Content
  rating            Int      // 1-5 stars
  title             String?  // Optional review title
  content           String   @db.Text // Review text
  images            String[] // Photo evidence of experience (max 5)

  // Review Type
  reviewType        String   @default("general") // 'general' | 'accommodation' | 'tour'
  serviceType       String?  // Which service: 'room', 'tour', 'restaurant', etc.
  specificItemId    String?  // ID of specific room/tour if applicable

  // Verification
  isVerified        Boolean  @default(false) // Verified as legitimate customer
  verifiedPurchase  Boolean  @default(false) // Confirmed they booked through platform

  // Moderation
  status            String   @default("pending") // 'pending' | 'approved' | 'rejected' | 'flagged'
  moderatedBy       String?  // Admin who moderated
  moderatedAt       DateTime?
  rejectionReason   String?

  // Metrics
  helpfulCount      Int      @default(0) // How many found this helpful
  reportCount       Int      @default(0) // How many flagged as inappropriate

  // Visibility
  isPublished       Boolean  @default(false)
  publishedAt       DateTime?

  // Business Response
  hasResponse       Boolean  @default(false)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  business          User     @relation("BusinessReviews", fields: [businessId], references: [id], onDelete: Cascade)
  reviewer          User     @relation("UserReviews", fields: [userId], references: [id], onDelete: Cascade)
  hunt              Hunt?    @relation(fields: [huntId], references: [id], onDelete: SetNull)
  response          ReviewResponse?
  helpfulVotes      ReviewHelpful[]

  @@unique([userId, businessId, huntId]) // One review per user per business per hunt
  @@index([businessId, status, isPublished])
  @@index([userId])
  @@index([rating])
  @@index([createdAt])
}

model ReviewResponse {
  id                String   @id @default(cuid())
  reviewId          String   @unique

  // Response Content
  content           String   @db.Text
  respondedBy       String   // Business owner/manager user ID

  // Moderation (businesses can't delete responses, only edit)
  isEdited          Boolean  @default(false)
  editedAt          DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  review            Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  responder         User     @relation("ReviewResponses", fields: [respondedBy], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@index([respondedBy])
}

model ReviewHelpful {
  id                String   @id @default(cuid())
  reviewId          String
  userId            String

  createdAt         DateTime @default(now())

  review            Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user              User     @relation("ReviewHelpfulVotes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId]) // One vote per user per review
  @@index([reviewId])
}

// ============================================
// CONVERSION TRACKING & OPTIMIZATION
// ============================================

model ConversionEvent {
  id                String   @id @default(cuid())

  // Source
  platform          String   // 'booking' | 'agoda' | 'getyourguide' | 'viator' etc.
  eventType         String   // 'booking' | 'confirmation' | 'cancellation' | 'completion'

  // Linked Data
  affiliateClickId  String?  // Link back to original click if possible
  businessId        String   // Which business
  roomTypeId        String?
  tourExperienceId  String?

  // Event Details
  bookingReference  String?  // Platform's booking ID
  bookingValue      Float?   // Total booking value
  currency          String?  @default("EUR")
  commission        Float?   // Actual commission earned
  commissionCurrency String? @default("EUR")

  // Booking Details
  checkInDate       DateTime?
  checkOutDate      DateTime?
  guests            Int?
  nights            Int?

  // Webhook Data
  webhookPayload    Json?    // Raw webhook data
  webhookSignature  String?  // For verification
  processingStatus  String   @default("pending") // 'pending' | 'processed' | 'failed' | 'duplicate'
  processingError   String?

  // Customer Info (if available, hashed/anonymized)
  customerEmail     String?  // Hashed email for deduplication
  customerId        String?  // Platform's customer ID

  receivedAt        DateTime @default(now())
  processedAt       DateTime?

  @@index([platform, eventType])
  @@index([businessId, receivedAt])
  @@index([bookingReference])
  @@index([processingStatus])
  @@index([affiliateClickId])
}

model CTAVariant {
  id                String   @id @default(cuid())

  // Business & Service
  businessId        String?  // Null = platform-wide test
  serviceType       String?  // 'accommodation' | 'tours' | null for all

  // Variant Details
  name              String   // "Green Bold Button", "Red Subtle", "Blue Animated"
  buttonText        String   // "Book Now" | "Check Availability" | "Reserve Your Spot"
  buttonColor       String   // Hex color code
  buttonStyle       String   // 'solid' | 'outline' | 'ghost'
  placement         String   // 'top' | 'bottom' | 'both'
  size              String   @default("medium") // 'small' | 'medium' | 'large'

  // A/B Test Settings
  isActive          Boolean  @default(true)
  trafficAllocation Float    @default(50) // Percentage of traffic (0-100)
  startDate         DateTime @default(now())
  endDate           DateTime?

  // Performance Metrics (updated periodically)
  impressions       Int      @default(0) // Times shown
  clicks            Int      @default(0) // Times clicked
  conversions       Int      @default(0) // Times resulted in booking
  clickThroughRate  Float    @default(0) // CTR %
  conversionRate    Float    @default(0) // CR %
  revenue           Float    @default(0) // Total revenue generated
  lastUpdated       DateTime @default(now())

  createdAt         DateTime @default(now())

  affiliateClicks   AffiliateClick[] // Clicks using this variant

  @@index([businessId, isActive])
  @@index([serviceType])
  @@index([isActive, startDate])
}

// ============================================
// ADVANCED AURORA FORECASTING MODELS
// ============================================

model UserLocationPreference {
  id                    String   @id @default(cuid())
  userId                String   @unique
  latitude              Float
  longitude             Float
  cityName              String
  alertsEnabled         Boolean  @default(false)
  notificationThreshold Float    @default(4.0) // Kp threshold for alerts
  emailAlerts           Boolean  @default(false)
  pushAlerts            Boolean  @default(true)

  // Alert frequency settings
  maxAlertsPerDay       Int      @default(5)
  quietHoursStart       Int?     // Hour in 24h format (e.g., 8 for 8 AM)
  quietHoursEnd         Int?     // Hour in 24h format (e.g., 22 for 10 PM)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model MagnetometerReading {
  id          String   @id @default(cuid())
  stationCode String   // Station identifier (e.g., "TRO", "ABK", "LYR")
  stationName String?  // Human-readable station name
  network     String?  // Network name (e.g., "IMAGE", "CANMOS", "THEMIS")
  timestamp   DateTime

  // Magnetic field components (nanoTesla)
  bx          Float?   // Geographic north component
  by          Float?   // Geographic east component
  bz          Float?   // Vertical component
  deltaB      Float    // Total perturbation magnitude in nT

  // Station location
  latitude    Float?
  longitude   Float?
  geomagLat   Float?   // Geomagnetic latitude

  createdAt   DateTime @default(now())

  @@unique([stationCode, timestamp])
  @@index([stationCode, timestamp])
  @@index([timestamp])
  @@index([network])
}

model SubstormEvent {
  id              String   @id @default(cuid())
  onsetTime       DateTime // When substorm onset was detected
  peakTime        DateTime? // When peak was reached
  recoveryTime    DateTime? // When recovery phase began
  endTime         DateTime? // When substorm ended

  peakDeltaB      Float    // Maximum perturbation in nT
  phase           String   // 'onset' | 'expansion' | 'recovery' | 'ended'

  // Detection metadata
  confidence      Float    // 0-1 confidence score
  detectionMethod String   @default("magnetometer") // 'magnetometer' | 'auroral_power' | 'combined'

  // Geographic extent
  mlat            Float?   // Magnetic latitude of onset
  mlt             Float?   // Magnetic local time of onset

  // Source stations
  sourceStations  String[] // Station codes that detected the substorm

  // Related data
  kpAtOnset       Float?   // Kp index at onset time
  bzAtOnset       Float?   // Bz component at onset time

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([onsetTime])
  @@index([phase])
  @@index([confidence])
}

model QuickSighting {
  id        String   @id @default(cuid())
  userId    String
  latitude  Float
  longitude Float
  cityName  String?  // Reverse geocoded city name
  countryCode String? // ISO country code

  timestamp DateTime @default(now())
  intensity Int      // 1-5 scale (1=faint, 5=very bright)

  // Optional additional data
  colors    String[] // Observed colors (green, purple, red, etc.)
  structure String?  // 'arc' | 'band' | 'corona' | 'diffuse' | 'pulsating'
  direction String?  // Cardinal direction where aurora was seen

  // Automatic expiration (2 hours after creation)
  expiresAt DateTime

  // Verification
  isVerified Boolean @default(false) // Verified by photo or multiple users
  verifiedBy String? // User ID who verified (if applicable)

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([timestamp])
  @@index([expiresAt])
  @@index([latitude, longitude])
  @@index([userId, timestamp])
}

model CameraNetwork {
  id            String   @id @default(cuid())
  networkCode   String   @unique // e.g., "THEMIS", "MIRACLE", "TROMSO"
  networkName   String   // Human-readable name
  region        String   // Geographic region covered

  // API/Feed information
  apiEndpoint   String?  // API URL if available
  feedUrl       String?  // Image feed URL
  updateFrequency Int    @default(60) // Seconds between updates

  // Status
  isActive      Boolean  @default(true)
  lastCheckTime DateTime?
  lastStatus    String?  // 'online' | 'offline' | 'degraded'

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  stations      CameraStation[]
}

model CameraStation {
  id            String   @id @default(cuid())
  networkId     String
  stationCode   String   // e.g., "FSIM", "GILL", "RANK"
  stationName   String   // Human-readable name

  latitude      Float
  longitude     Float

  // Camera specifications
  fieldOfView   Float?   // Degrees
  elevation     Float?   // Meters above sea level

  // Feed information
  imageUrl      String?  // Current image URL
  videoUrl      String?  // Video stream URL if available

  // Status
  isActive      Boolean  @default(true)
  lastImageTime DateTime?
  currentStatus String   @default("unknown") // 'clear' | 'cloudy' | 'aurora' | 'offline' | 'unknown'

  // Aurora detection
  auroraDetected Boolean @default(false)
  auroraConfidence Float? // 0-1 confidence of aurora detection
  lastAuroraTime DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  network       CameraNetwork @relation(fields: [networkId], references: [id], onDelete: Cascade)

  @@unique([networkId, stationCode])
  @@index([latitude, longitude])
  @@index([auroraDetected])
}

model ForecastEntry {
  id            String   @id @default(cuid())
  forecastTime  DateTime // The time this forecast is for
  generatedAt   DateTime // When the forecast was generated
  source        String   // 'gfz' | 'noaa' | 'internal'

  // Predicted values
  predictedKp   Float
  predictedKpMin Float?  // Lower bound of prediction
  predictedKpMax Float?  // Upper bound of prediction

  // Confidence and uncertainty
  confidence    Float    // 0-1 confidence score
  uncertainty   Float?   // Standard deviation or similar

  // Additional predictions
  predictedBz   Float?
  predictedSpeed Float?

  // Source metadata
  modelVersion  String?  // Version of the prediction model

  createdAt     DateTime @default(now())

  @@unique([forecastTime, source])
  @@index([forecastTime])
  @@index([source])
}
